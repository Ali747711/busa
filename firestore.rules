rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Check user's role from Firestore — single source of truth.
    // Uses exists() guard so rules don't throw when the user document hasn't been created yet.
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isMentor() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        userDoc().data.role in ['mentor', 'admin'];
    }

    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        userDoc().data.role == 'admin';
    }

    // Sessions — public read, mentor write.
    // Unauthenticated users may update only currentAttendees (registration flow).
    match /sessions/{document} {
      allow read: if true;
      allow create, delete: if isMentor();
      allow update: if isMentor() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentAttendees']);
    }

    // Events — same policy as sessions
    match /events/{document} {
      allow read: if true;
      allow create, delete: if isMentor();
      allow update: if isMentor() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentAttendees']);
    }

    match /mentors/{document} {
      allow read: if true;
      allow write: if isMentor();
    }

    match /content/{document} {
      allow read: if true;
      allow write: if isMentor();
    }

    match /siteConfig/{document} {
      allow read: if true;
      allow write: if isMentor();
    }

    match /success-stories/{document} {
      allow read: if true;
      allow write: if isMentor();
    }

    // Registrations — anyone can submit; only mentors can manage
    match /registrations/{document} {
      allow create: if true;
      allow read, update, delete: if isMentor();
    }

    match /photos/{photoId} {
      allow read: if true;
      allow write: if isMentor();
    }

    match /travel/{travelId} {
      allow read, write: if isMentor();
    }

    match /forms/{formId} {
      allow read, write: if isMentor();
    }

    // Users collection:
    // - Each user can read/write their own document (for role bootstrap & lastLogin)
    // - Mentors can read all users
    // - Only admins can change someone's role to 'admin'
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if isMentor();
      allow update: if isMentor() &&
        (
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) ||
          (request.resource.data.role != 'admin' || isAdmin())
        );
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
